---
title: "Bulk RNA-seq Gene Set Enrichment"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: inline
---

## Introduction

This document presents the Gene Set Analysis for the bulk RNA-seq data in this project.

The analyisis is performed using fGSEA (Sergushichev A (2016). “An algorithm for fast preranked gene set enrichment analysis using cumulative statistic calculation.” bioRxiv. doi: 10.1101/060012, http://biorxiv.org/content/early/2016/06/20/060012).

```{r, message = FALSE, warning = FALSE}
library(tidyverse)
library(DESeq2)
# library(gage)
library(fgsea)
library(DT)
# knitr::opts_chunk$set(cache = T, autodep = T)

datatable(NULL)
```

```{r}
# gagePvalue<-0.01
# runExtraComps<-TRUE
```

```{r listGMTfiles, cache=FALSE}
data("signatures")
pathways <- c(signatures[["H"]],
              signatures[["lineages"]][c("ProB", "MLP", "MEP", "HSC",
                                         "GMP", "ETP", "EarlyB", "CMP")])
pathways_relapse <- signatures[["Relapse"]]
pathways_fetal <- signatures[["fetal_lineages"]]
names(pathways) <- gsub("HALLMARK_", "", names(pathways))

```


```{r, results = "asis", fig.height = 10, warnings = FALSE}
print_deseq2_results <- function(my_res) {
  print(htmltools::tagList(
    datatable(my_res %>% rename("log2FoldChange" = "log2FC") %>%
                filter(padj < 0.05 & stat > 0) %>% arrange(desc(stat)) %>% head(n = 100),
              caption = paste("TOP 100"),
              options = list(dom = 'frtip',
                             pageLength = 5)
              ) %>%
      formatSignif(columns=c('log2FC', 'stat', 'pvalue', 'padj'), digits=3) %>%
      formatStyle(columns = c("ensgene", "symbol"), fontWeight = "bold"),
    htmltools::tags$br(),
    datatable(my_res %>% rename("log2FoldChange" = "log2FC") %>%
                filter(padj < 0.05 & stat < 0) %>% arrange(stat) %>% head(n = 100),
              caption = paste("BOTTOM 100"),
              options = list(dom = 'frtip',
                             pageLength = 5)
              ) %>%
      formatSignif(columns=c('log2FC', 'stat', 'pvalue', 'padj'), digits=3) %>%
      formatStyle(columns = c("ensgene", "symbol"), fontWeight = "bold"),
    htmltools::tags$br()
  ))
}

run_fgsea <- function(my_res, pathways) {
  my_res <- my_res[complete.cases(my_res),]
  my_res <- my_res %>% arrange(stat)
  stat <- my_res$stat
  names(stat) <- my_res$symbol
  fgseaRes <- fgsea(pathways, stat, nperm=10000)
  
  # Change the e! stable IDs into gene symbols in the leading edge list (col #8)
  # fgseaRes[, 8] <- apply(
  #   fgseaRes, 1, function(x) {
  #     sapply(unlist(x[8]), function(y) {
  #       my_res %>% filter(symbol == y) %>% pull(symbol) %>% unique()
  #       })
  #     })
  print(htmltools::tagList(
    datatable(fgseaRes,
              options = list(dom = 'frtip')
              ) %>%
      formatSignif(columns=c('pval', 'padj', 'ES', 'NES'), digits=3) %>%
      formatStyle(
        'padj',
        target = "row",
        fontWeight = styleInterval(0.05, c('bold', 'normal'))),
    htmltools::tags$br()
  ))

  fgseaRes_sig <- fgseaRes[fgseaRes$padj < 0.05,]
  fgseaRes_sig <- fgseaRes_sig[order(fgseaRes_sig$NES),]
  cat("\n\n")
  grid::grid.newpage()
  plotGseaTable(pathways[fgseaRes_sig$pathway], stat, fgseaRes_sig, gseaParam = 0.4)
  cat("\n\n")

  g <- ggplot(fgseaRes, aes(reorder(pathway, NES), NES)) +
    geom_col(aes(fill=padj<0.05), col = "black") +
    coord_flip() +
    labs(x="Pathway", y="Normalized Enrichment Score",
         title="Hallmarks and signatures") +
    scale_fill_manual(limits = c(T, F), values = c("#999999", "#EEEEEE")) +
    theme_minimal()
  print(g)
  cat("\n\n")
  return(invisible(fgseaRes))
}

run_gage <- function(my_res, pathways) {
  foldchanges = my_res$log2FoldChange
  names(foldchanges) = my_res$symbol
  head(foldchanges)
  gage_res = gage(foldchanges, gsets=pathways, same.dir=TRUE)
  
  gage_res <- gage_res$greater %>%
    as_tibble(rownames = "pathway") %>%
    left_join(gage_res$less %>% as_tibble(rownames = "pathway"),
              by = c("pathway", "stat.mean", "set.size")) %>%
    mutate(p.val = ifelse(p.val.x < p.val.y, p.val.x, p.val.y)) %>%
    dplyr::select(-c(p.val.x, p.val.y)) %>%
    mutate(q.val = ifelse(q.val.x < q.val.y, q.val.x, q.val.y)) %>%
    dplyr::select(-c(q.val.x, q.val.y)) %>%
    dplyr::select(-c(p.geomean.x, p.geomean.y, exp1.x, exp1.y)) %>%
    arrange(desc(stat.mean))

  print(htmltools::tagList(
    htmltools::tags$br(),
    datatable(gage_res,
              caption = "GAGE",
              options = list(dom = 'frtip')
              ) %>%
      formatSignif(columns=c('stat.mean', 'p.val', 'q.val'), digits=3) %>%
      formatStyle(
        'q.val',
        target = "row",
        fontWeight = styleInterval(0.05, c('bold', 'normal'))),
    htmltools::tags$br()
  ))

  g <- ggplot(gage_res, aes(reorder(pathway, stat.mean), stat.mean)) +
    geom_col(aes(fill=q.val < 0.05), col = "black") +
    coord_flip() +
    labs(x="Pathway", y="Statistic",
         title="Hallmarks and signatures") +
    scale_fill_manual(limits = c(T, F), values = c("#999999", "#EEEEEE")) +
    theme_minimal()
  print(g)
  cat("\n\n")
  return(invisible(gage_res))
}
```

## Results

```{r}
fgsea_results <- list()
fgsea_results_relapse <- list()
fgsea_results_fetal <- list()
# gage_results <- list()
```

### Treated vs Untreated (PT1 + PT12 + PT13)

```{r, results = "asis", fig.height = 10, warnings = FALSE}
bulk_res <- readRDS("output/deseq2-mini_bulk4_dds.3pts-Treated-vs-Untreated.rds")
tag <- "treated_vs_untreated.3pts"
# print_deseq2_results(bulk_res)
# cat("### fGSEA\n")
fgsea_results[[tag]] <- run_fgsea(bulk_res, pathways)
fgsea_results_relapse[[tag]] <- run_fgsea(bulk_res, pathways_relapse)
fgsea_results_fetal[[tag]] <- run_fgsea(bulk_res, pathways_fetal)
# cat("### GAGE\n")
# gage_results[[tag]] <- run_gage(bulk_res, pathways)
```

### Treated vs Untreated (PT1)

```{r, results = "asis", fig.height = 10, warnings = FALSE}
bulk_res <- readRDS("output/deseq2-mini_bulk4_dds.pt1-Treated-vs-Untreated.rds")
tag <- "treated_vs_untreated.pt1"
# print_deseq2_results(bulk_res)
# cat("### fGSEA\n")
fgsea_results[[tag]] <- run_fgsea(bulk_res, pathways)
fgsea_results_relapse[[tag]] <- run_fgsea(bulk_res, pathways_relapse)
fgsea_results_fetal[[tag]] <- run_fgsea(bulk_res, pathways_fetal)
# cat("### GAGE\n")
# gage_results[[tag]] <- run_gage(bulk_res, pathways)
```

### Treated vs Untreated (PT12)

```{r, results = "asis", fig.height = 10, warnings = FALSE}
bulk_res <- readRDS("output/deseq2-mini_bulk4_dds.pt12-Treated-vs-Untreated.rds")
tag <- "treated_vs_untreated.pt12"
# print_deseq2_results(bulk_res)
# cat("### fGSEA\n")
fgsea_results[[tag]] <- run_fgsea(bulk_res, pathways)
fgsea_results_relapse[[tag]] <- run_fgsea(bulk_res, pathways_relapse)
fgsea_results_fetal[[tag]] <- run_fgsea(bulk_res, pathways_fetal)
# cat("### GAGE\n")
# gage_results[[tag]] <- run_gage(bulk_res, pathways)
```

### Treated vs Untreated (PT13)

```{r, results = "asis", fig.height = 10, warnings = FALSE}
bulk_res <- readRDS("output/deseq2-mini_bulk4_dds.pt13-Treated-vs-Untreated.rds")
tag <- "treated_vs_untreated.pt13"
# print_deseq2_results(bulk_res)
# cat("### fGSEA\n")
fgsea_results[[tag]] <- run_fgsea(bulk_res, pathways)
fgsea_results_relapse[[tag]] <- run_fgsea(bulk_res, pathways_relapse)
fgsea_results_fetal[[tag]] <- run_fgsea(bulk_res, pathways_fetal)
# cat("### GAGE\n")
# gage_results[[tag]] <- run_gage(bulk_res, pathways)
```

### Acutely treated vs Never treated (PT2)

```{r, results = "asis", fig.height = 10, warnings = FALSE}
bulk_res <- readRDS("output/deseq2-mini_bulk4_dds.pt2-Acutely treated-vs-Never treated.rds")
tag <- "acute_vs_never"
# print_deseq2_results(bulk_res)
# cat("### fGSEA\n")
fgsea_results[[tag]] <- run_fgsea(bulk_res, pathways)
fgsea_results_relapse[[tag]] <- run_fgsea(bulk_res, pathways_relapse)
fgsea_results_fetal[[tag]] <- run_fgsea(bulk_res, pathways_fetal)
# cat("### GAGE\n")
# gage_results[[tag]] <- run_gage(bulk_res, pathways)
```

### Chronically treated vs Never treated (PT2)

```{r, results = "asis", fig.height = 10, warnings = FALSE}
bulk_res <- readRDS("output/deseq2-mini_bulk4_dds.pt2-Chronically treated-vs-Never treated.rds")
tag <- "chronic_vs_never"
# print_deseq2_results(bulk_res)
# cat("### fGSEA\n")
fgsea_results[[tag]] <- run_fgsea(bulk_res, pathways)
fgsea_results_relapse[[tag]] <- run_fgsea(bulk_res, pathways_relapse)
fgsea_results_fetal[[tag]] <- run_fgsea(bulk_res, pathways_fetal)
# cat("### GAGE\n")
# gage_results[[tag]] <- run_gage(bulk_res, pathways)
```

### Relapse vs Never treated (PT2)

```{r, results = "asis", fig.height = 10, warnings = FALSE}
bulk_res <- readRDS("output/deseq2-mini_bulk4_dds.pt2-Relapse-vs-Never treated.rds")
tag <- "relapse_vs_never"
# print_deseq2_results(bulk_res)
# cat("### fGSEA\n")
fgsea_results[[tag]] <- run_fgsea(bulk_res, pathways)
fgsea_results_relapse[[tag]] <- run_fgsea(bulk_res, pathways_relapse)
fgsea_results_fetal[[tag]] <- run_fgsea(bulk_res, pathways_fetal)
# cat("### GAGE\n")
# gage_results[[tag]] <- run_gage(bulk_res, pathways)
```

### Treatment withdrawn vs Never treated (PT2)

```{r, results = "asis", fig.height = 10, warnings = FALSE}
bulk_res <- readRDS("output/deseq2-mini_bulk4_dds.pt2-Treatment withdrawn-vs-Never treated.rds")
tag <- "withdrawn_vs_never"
# print_deseq2_results(bulk_res)
# cat("### fGSEA\n")
fgsea_results[[tag]] <- run_fgsea(bulk_res, pathways)
fgsea_results_relapse[[tag]] <- run_fgsea(bulk_res, pathways_relapse)
fgsea_results_fetal[[tag]] <- run_fgsea(bulk_res, pathways_fetal)
# cat("### GAGE\n")
# gage_results[[tag]] <- run_gage(bulk_res, pathways)
```

### Acutely treated vs Chronically treated (PT2)

```{r, results = "asis", fig.height = 10, warnings = FALSE}
bulk_res <- readRDS("output/deseq2-mini_bulk4_dds.pt2-Acutely treated-vs-Chronically treated.rds")
tag <- "acute_vs_chronic"
# print_deseq2_results(bulk_res)
# cat("### fGSEA\n")
fgsea_results[[tag]] <- run_fgsea(bulk_res, pathways)
fgsea_results_relapse[[tag]] <- run_fgsea(bulk_res, pathways_relapse)
fgsea_results_fetal[[tag]] <- run_fgsea(bulk_res, pathways_fetal)
# cat("### GAGE\n")
# gage_results[[tag]] <- run_gage(bulk_res, pathways)
```

## Summary

```{r fig.height = 12}
saveRDS(fgsea_results, "output/fgsea_results.RDS")
saveRDS(fgsea_results_relapse, "output/fgsea_results_relapse.RDS")
saveRDS(fgsea_results_fetal, "output/fgsea_results_fetal.RDS")
# saveRDS(gage_results, "output/gage_results.RDS")
```


### Heatmaps

```{r fig.height = 12}
fgsea_tibble <- lapply(names(fgsea_results), function(x) {tibble(set = x, fgsea_results[[x]])}) %>%
  transpose() %>% as_tibble() %>% unnest()

ggplot(data = fgsea_tibble) +
  geom_tile(aes(x = set, y = pathway, fill = NES,
                width = 0.3 + 0.7 * (padj < 0.05),
                height = 0.3 + 0.7 * (padj < 0.05))) +
  geom_vline(xintercept = 2.5) +
  scale_fill_gradientn(
    name = " ",
    colours = c(scales::muted("blue"), "white", scales::muted("red")),
    values = c(0, 0.3, 0.499999, 0.5, 0.511111, 0.7, 1),
    limits = c(-max(abs(range(fgsea_tibble$NES))), max(abs(range(fgsea_tibble$NES))))) +
  scale_x_discrete(limits = c("treated_vs_untreated.3pts",
                              "treated_vs_untreated.2pts",
                              "treated_vs_untreated.pt1",
                              "treated_vs_untreated.pt12",
                              "treated_vs_untreated.pt13")) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))


ggplot(data = fgsea_tibble) +
  geom_tile(aes(x = set, y = pathway, fill = NES,
                width = 0.3 + 0.7 * (padj < 0.05),
                height = 0.3 + 0.7 * (padj < 0.05))) +
  geom_vline(xintercept = 2.5) +
  scale_fill_gradientn(
    name = " ",
    colours = c(scales::muted("blue"), "white", scales::muted("red")),
    values = c(0, 0.3, 0.499999, 0.5, 0.511111, 0.7, 1),
    limits = c(-max(abs(range(fgsea_tibble$NES))), max(abs(range(fgsea_tibble$NES))))) +
  scale_x_discrete(limits = c("treated_vs_untreated.3pts",
                              "treated_vs_untreated.2pts",
                              "acute_vs_never",
                              "chronic_vs_never",
                              "acute_vs_chronic",
                              "relapse_vs_never",
                              "withdrawn_vs_never")) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
```

### Barplots

```{r barplots.common_mappings}
barplot_common_mappings <- list(
  geom_col(aes(fill = paste(padj < 0.05, NES < 0)), col = "black"),
  coord_flip(),
  facet_grid(rows = ~ set),
  labs(x="Gene set", y="Normalized Enrichment Score",
       title="Hallmarks and signatures"),
  scale_fill_manual(name = "NES",
                    limits = c("TRUE FALSE", "FALSE FALSE", "FALSE TRUE", "TRUE TRUE"),
                    labels = c("signif, pos", "non-signif, pos", "non-signif, neg", "signif, neg"),
                    values = c(scales::muted("red"),
                               scales::alpha(scales::muted("red"), 0.2),
                               scales::alpha(scales::muted("blue"), 0.2),
                               scales::muted("blue"))),
  geom_hline(yintercept = 0),
  scale_y_continuous(trans = scales::pseudo_log_trans()),
  theme_minimal()
)
```

#### Main signatures

```{r, fig.height = 12, fig.width = 15}
fgsea_tibble$set <- factor(fgsea_tibble$set,
                           levels = c("treated_vs_untreated.3pts",
                                      "treated_vs_untreated.pt1",
                                      "treated_vs_untreated.pt12",
                                      "treated_vs_untreated.pt13",
                                      "acute_vs_never",
                                      "chronic_vs_never",
                                      "acute_vs_chronic",
                                      "relapse_vs_never",
                                      "withdrawn_vs_never"))
fgsea_tibble$set_name <- fgsea_tibble$set
levels(fgsea_tibble$set_name)[1] <- "PT1 + PT12 + PT13\ntreated vs untreated"
levels(fgsea_tibble$set_name)[2] <- "PT1\ntreated vs untreated"
levels(fgsea_tibble$set_name)[3] <- "PT12\ntreated vs untreated"
levels(fgsea_tibble$set_name)[4] <- "PT13\ntreated vs untreated"
levels(fgsea_tibble$set_name)[5] <- "PT2\nacute vs untreated"
levels(fgsea_tibble$set_name)[6] <- "PT2\nchronic vs untreated"
levels(fgsea_tibble$set_name)[7] <- "PT2\nacute vs chronic"
levels(fgsea_tibble$set_name)[8] <- "PT2\nrelapse vs untreated"
levels(fgsea_tibble$set_name)[9] <- "PT2\nwithdrawn vs untreated"

g <- ggplot(fgsea_tibble %>%
              filter(set %in% c("treated_vs_untreated.3pts",
                                "treated_vs_untreated.pt1",
                                "treated_vs_untreated.pt12",
                                "treated_vs_untreated.pt13",
                                "acute_vs_never",
                                "chronic_vs_never")) %>%
              mutate(set = set_name) %>%
              group_by(pathway) %>%
              mutate(mean.NES = mean(NES)) %>%
              mutate(min.padj = min(padj)) %>%
              filter(min.padj < 0.05),
            aes(reorder(pathway, mean.NES), NES)) +
  barplot_common_mappings
print(g)


g <- ggplot(fgsea_tibble %>%
              filter(set %in% c("treated_vs_untreated.3pts",
                                "acute_vs_never",
                                "chronic_vs_never",
                                "acute_vs_chronic",
                                "relapse_vs_never",
                                "withdrawn_vs_never"))  %>%
              mutate(set = set_name) %>%
              group_by(pathway) %>%
              mutate(mean.NES = mean(NES)) %>%
              mutate(min.padj = min(padj)) %>%
              filter(min.padj < 0.05),
            aes(reorder(pathway, mean.NES), NES)) +
  barplot_common_mappings
print(g)

pdf("output/figures/ItemS2.pdf", height = 10, width = 6)
g <- g +
  theme(legend.position = "bottom",
        legend.key.size = unit(0.1, "inch"),
        legend.box.margin = margin(c(0, 100, 0, 0)),
        strip.text = element_text(size = 4),
        axis.text.x = element_text(size = 6),
        axis.text.y = element_text(size = 6)) 
print(g)
dev.off()
```

#### Selected signatures

```{r, fig.height = 5, fig.width = 12}
g <- ggplot(fgsea_tibble %>%
              filter(set %in% c("treated_vs_untreated.3pts",
                                "acute_vs_never",
                                "chronic_vs_never",
                                "relapse_vs_never",
                                "withdrawn_vs_never")) %>%
              filter(pathway %in% c("G2M_CHECKPOINT",
                                    "E2F_TARGETS",
                                    "MYC_TARGETS_V1",
                                    # "MYC_TARGETS_V2",
                                    "OXIDATIVE_PHOSPHORYLATION",
                                    "MITOTIC_SPINDLE",
                                    "DNA_REPAIR",
                                    "COMPLEMENT",
                                    "HSC",
                                    "MLP",
                                    "ProB")) %>%
              mutate(set = set_name) %>%
              mutate(pathway = ifelse(pathway == "OXIDATIVE_PHOSPHORYLATION", "OXIDATIVE_   \nPHOSPHORYLATION", pathway)) %>%
              group_by(pathway) %>%
              mutate(mean.NES = mean(NES)) %>%
              mutate(min.padj = min(padj)),
            aes(reorder(pathway, mean.NES), NES)) +
  barplot_common_mappings +
  labs(title = NULL) +
  theme(text = element_text(size = 14))
print(g +
        scale_x_discrete(limits = c(
          "ProB",
          "MLP",
          "HSC",
          "",
          "COMPLEMENT",
          "MITOTIC_SPINDLE",
          "OXIDATIVE_   \nPHOSPHORYLATION",
          "DNA_REPAIR",
          # "MYC_TARGETS_V2",
          "G2M_CHECKPOINT",
          "MYC_TARGETS_V1",
          "E2F_TARGETS"
          )) +
        geom_tile(aes(x = 4, y = 0, width = 0.8, height = Inf), fill = "white", col = NA)
        # geom_vline(xintercept = c(3, 8), col = "white", size = 10)
)

ggsave("output/figures/Fig5C_fgsea_selected_signatures.pdf", device = "pdf",
       height = 5, width = 12)
```

### Relapse mixed behaviour

This first plot shows the hallmarks and signatures that are maintained in the relapse PDX w.r.t. acute and chronically treated:

```{r relapse_mixed_behaviour.barplot.maintain}
fgsea_summary <- fgsea_tibble %>%
  mutate(res = sign(NES) * (1 + (padj < 0.05))) %>%
  dplyr::select(pathway, set, res) %>%
  dplyr::filter(set %in% c("acute_vs_never", "chronic_vs_never",
                           "relapse_vs_never", "withdrawn_vs_never")) %>%
  pivot_wider(names_from = set, values_from = res)

selected_pathways_maintain <- fgsea_summary %>%
  dplyr::filter(abs(acute_vs_never) == 2 & chronic_vs_never == acute_vs_never &
           relapse_vs_never == acute_vs_never & abs(withdrawn_vs_never) < 2) %>%
  pull(pathway)


g <- ggplot(fgsea_tibble %>%
              dplyr::filter(pathway %in% selected_pathways_maintain) %>%
              dplyr::filter(set %in% c("acute_vs_never",
                                "chronic_vs_never",
                                "relapse_vs_never",
                                "withdrawn_vs_never"))  %>%
              dplyr::mutate(set = sub("_vs_never", "", set)) %>%
              dplyr::group_by(pathway) %>%
              dplyr::mutate(mean.NES = mean(NES)) %>%
              dplyr::mutate(min.padj = min(padj)) %>%
              dplyr::filter(min.padj < 0.05),
            aes(reorder(pathway, mean.NES), NES)) +
  barplot_common_mappings
print(g)
```


This second plot shows the hallmarks and signatures that revert in the relapse PDX w.r.t. acute and chronically treated:

```{r relapse_mixed_behaviour.barplot.revert}
selected_pathways_revert <- fgsea_summary %>%
  dplyr::filter(abs(acute_vs_never) == 2 & chronic_vs_never == acute_vs_never &
                  abs(relapse_vs_never) < 2 & abs(withdrawn_vs_never) < 2 &
                  relapse_vs_never == withdrawn_vs_never) %>%
  pull(pathway)

g <- ggplot(fgsea_tibble %>%
              dplyr::filter(pathway %in% selected_pathways_revert) %>%
              dplyr::filter(set %in% c("acute_vs_never",
                                "chronic_vs_never",
                                "relapse_vs_never",
                                "withdrawn_vs_never"))  %>%
              dplyr::mutate(set = sub("_vs_never", "", set)) %>%
              dplyr::group_by(pathway) %>%
              dplyr::mutate(mean.NES = mean(NES)) %>%
              dplyr::mutate(min.padj = min(padj)) %>%
              dplyr::filter(min.padj < 0.05),
            aes(reorder(pathway, mean.NES), NES)) +
  barplot_common_mappings
print(g)
```

